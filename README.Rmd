---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# paneldesign

<!-- badges: start -->
[![R-CMD-check](https://github.com/TRON-Private/paneldesign/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/TRON-Private/paneldesign/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of this R package is to provide functionalities to design and evaluate panels. 

https://tron.pages.gitlab.rlp.net/paneldesign

## Installation

### Install Bioconductor dependencies

This package dependes on the Biocondocr packages [GenomicRanges](https://bioconductor.org/packages/release/bioc/html/GenomicRanges.html) and
[GenomeInfoDb](https://bioconductor.org/packages/release/bioc/html/GenomeInfoDb.html). 
Install it by 

``` r
install.packages("BiocManager") # if needed
BiocManager::install(c("GenomicRanges", "GenomeInfoDb"))
```

### Install this package from this GitLab


This R packge is not yet on [CRAN](https://CRAN.R-project.org) or
[Biodonducotr](https://www.bioconductor.org/). Therfore, you have to install it
form this GitLap repository. 

However, this repository is a private GitLab reposoritory and therfore you have to 
create an personal access token (PAT) first. This is described [here](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html).
As Scope use `api` or `read_api`.  


``` r
install.packages("remotes") # if needed

remotes::install_gitlab("tron/paneldesign", host = "gitlab.rlp.net", auth_token = "YOUR_ACCESS_TOKEN")

```


## Usage example

This is a basic example to show you how to use the package:

```{r example, message = FALSE}
library(GenomicRanges)
library(paneldesign)

```

Given a data set of mutations in patients, the goal is to select mutations that are present in a maximum number of patients. 
We use a toy data set consisting of patients `p1`, `p2`, and `p3` of which each has 3 mutations.

```{r toy data}
mut_toy
```


### Select mutations

Here, we use a greedy algorithm to select a minimal set of mutations that 
covers all patients. 

```{r}
select_greedy(mut_toy)
```

This results in two mutations `m01` and `m02`.

### Evaluate given panel of regions

Here we use the following toy genomic region set.

```{r}
gr_toy
```

First, we associate each region to patients by overlap with the mutation data

```{r}
reg_to_patient <- panel_to_patient(gr_toy, mut_toy)

reg_to_patient
```

This results in the above-shown data set. The patient `p3` is not *covered* 
because there are no mutations in `p3` that overlap with the input regions. 
This results in 'NA' values for some region or mutation-specific columns. 

Next, we evaluate each region from the panel for the patient coverage.

```{r}
eval_regions(reg_to_patient)

```

This assumes some order of the input regions by decreasing priority and in this
way outputs additionally cumulative values such as `percent_patients_cum` which 
the cumulative percent of input patients that are covered by the current or any 
previous region. This is useful to decide where to *cut* the panel.

Lastly, we can get some overall performance metrics of the entire panel:

```{r}
eval <- eval_panel(reg_to_patient)
eval
```

This data set contains a nested data set with information on how many mutations 
each patient has represented on the panel.

```{r}
eval$mut_per_patient_df[[1]]

```


### Structural variants

Structural variants (SVs) are represented as pairs of breakpoint coordinates. And to 
be covered by a panel region either a single (`sv_mode = "single"`) or both 
(`sv_mode = "both"`) breakpoints must be included in a region of the panel. 

An toy example SV dataset might look like this


```{r}
sv_toy
```

We can evaluate a dataset with mutations and SVs by passing it as additional input
to the `panel_to_patient()` function

```{r}
reg_to_patient <- panel_to_patient(gr_toy, mut_toy, sv_toy, sv_mode = "single")

```

Now the `reg_to_patient` table includes additonal colums for the SV breakpoint 
coordinates and includes here an association of SV `sv01` from patient `p4` with 
region `r1`. In contrast patient `p5`is not covered by the panel.

```{r}
reg_to_patient
```

